!function(t,i){PostcodeAPI=function(n){this.settings={apiURL:"//api.thepostcodeapi.com/",endpoint:"components",addressButtonText:n.addressButtonText==i?"Select":n.addressButtonText,apiKey:n.apiKey==i?!1:n.apiKey,buttonText:n.buttonText==i?"Lookup Address":n.buttonText,buttonClass:n.buttonClass==i?[]:n.buttonClass,concatSeparator:n.concatSeparator==i?", ":n.concatSeparator,debug:n.debug==i?!0:n.debug,field:n.field==i?null:n.field,fields:n.fields?n.fields:{line1:"line1+line2+line3",line2:"line4",line3:"line5+line6",town:"town",county:"county"},modal:n.modal==i?!0:n.modal,modalTitle:n.modalTitle==i?"Select Address:":n.modalTitle,selectId:n.selectId==i?"papi-select-address":n.selectId,selectClassName:n.selectClassName==i?"":n.selectClassName,type:n.type==i?"lightbox":n.type,txtNotFound:n.txtNotFound==i?"Postcode not found. Please try again":n.txtNotFound},this.init=function(){if(this.field=this.settings.field,null!==this.field){var i=this;this.button=document.createElement("button"),this.button.innerHTML=this.settings.buttonText,this._addClass(this.button,this.settings.buttonClass),this.button.onclick=function(s){e=s||t.event,e.preventDefault(),i.run(e)},this._insertAfter(this.button,this.field)}},this.run=function(){return this.queryVal=this._trim(this.field.value),this.settings.apiKey?""==this.queryVal?(this.field.focus(),this._console("Postcode field was empty","error"),!1):this.validatePostcode(this.queryVal)?("lightbox"==this.settings.type?this.showLightbox():"select"==this.settings.type?this.showSelect():(this._console('Invalid selection type specified. Falling back to "lightbox"',"warn"),this.showLightbox()),!0):(this.field.focus(),this._console(postcode+" is not a valid UK postcode format","error"),this._message("Postcode is invalid","papi-error",this.button),!1):(this._console("You must specify an API key","error"),!1)},this.showLightbox=function(){var t=this;this.lightboxCover=document.createElement("div"),this.lightboxContainer=document.createElement("div"),this.lightboxContainer.id="papi-lightbox-container",this.lightboxCover.id="papi-lightbox-cover",this.lightboxContainer.className="papi-lightbox-loading",document.body.appendChild(this.lightboxCover),document.body.appendChild(this.lightboxContainer),this.settings.modal||(this.lightboxCover.onclick=function(){t.lightboxContainer.remove(),t.lightboxCover.remove()}),this._fetch(function(e){var i=JSON.parse(e);if(0==i.count)t.lightboxContainer.remove(),t.lightboxCover.remove(),t._message(t.settings.txtNotFound);else{var s=document.createElement("header"),n=document.createElement("h3"),o=t._generateSelect(i,20),a=document.createElement("button"),r=document.createElement("footer"),l=document.createElement("div");n.innerHTML=t.settings.modalTitle,a.innerHTML=t.settings.addressButtonText,s.appendChild(n),r.appendChild(a),l.className="papi-lightbox-content",l.appendChild(o),a.onclick=function(){return o.selectedIndex<0?void o.focus():(t.lightboxContainer.remove(),t.lightboxCover.remove(),void t._selectAddress(o))},t.lightboxContainer.appendChild(s),t.lightboxContainer.appendChild(l),t.lightboxContainer.appendChild(r)}})},this.showSelect=function(){null!==document.getElementById(this.settings.selectId)&&document.getElementById(this.settings.selectId).remove();var t=this;this._fetch(function(e){var i=JSON.parse(e);if(0==i.count)t._message(t.settings.txtNotFound,"",t.button);else{var s=t._generateSelect(i,10);t._insertAfter(s,t.button),s.onchange=function(){t._selectAddress(this),this.remove()}}})},this.validatePostcode=function(t){return/^[A-Z]{1,2}[0-9]{1,2} ?[0-9][A-Z]{2}$/i.test(t)},this._selectAddress=function(t){var e=t.options[t.selectedIndex];for(var s in this.settings.fields){for(var n=this.settings.fields[s].split("+"),o="",a=0,r=n.length;r>a;a++){var l=e.getAttribute("data-"+n[a]);""!=l&&l!=i&&(o=""==o?l:o+l,o+=isNaN(parseInt(l))?this.settings.concatSeparator:" ")}var d=new RegExp(this.settings.concatSeparator+"$","g"),h=o.replace(d,"");this._getInput(s).value=h!=i?h:""}this.field.value=e.getAttribute("data-postcode")},this._generateSelect=function(t,e){var s=document.createElement("select");s.id=this.settings.selectId,s.className=this.settings.selectClassName,e!==i&&s.setAttribute("size",e);for(var n=0;n<t.count;n++){var o=t.results[n],a=document.createElement("option");a.innerHTML=o.formattedAddress,a.setAttribute("data-line1",o.line1),a.setAttribute("data-line2",o.line2),a.setAttribute("data-line3",o.line3),a.setAttribute("data-line4",o.line4),a.setAttribute("data-line5",o.line5),a.setAttribute("data-line6",o.line6),a.setAttribute("data-town",o.place.town),a.setAttribute("data-county",o.place.county),a.setAttribute("data-postcode",o.postcode),s.appendChild(a)}return s},this._fetch=function(t){s.request({url:this.settings.apiURL+this.settings.endpoint,method:"get",data:{key:this.settings.apiKey,postcode:this.queryVal}}).done(t)},this._getInput=function(t){return document.getElementsByName(t)[0]},this._insertAfter=function(t,e){var i=e.parentNode;i.lastchild==e?i.appendChild(t):i.insertBefore(t,e.nextSibling)},this._addClass=function(t,e){t!=i&&(t.className="object"==typeof e?e.join(" "):e)},this._trim=function(t){return t.replace(/\s/g,"")},this._message=function(t,e,i){var s=document.createElement("div");return s.attributes.className=e,s.innerHTML=t,this._insertAfter(s,i),s},this._console=function(e,i){var s=function(){};t.console||(t.console={log:s,info:s,warn:s,debug:s,error:s}),this.settings.debug&&console[i](e)},this.init()};var s={request:function(e){"string"==typeof e&&(e={url:e}),e.url=e.url||"",e.method=e.method||"get",e.data=e.data||{};var i=function(t,e){var i,s=[];for(var n in t)s.push(n+"="+encodeURIComponent(t[n]));return i=s.join("&"),""!=i?e?e.indexOf("?")<0?"?"+i:"&"+i:i:""},s={host:{},process:function(e){var s=this;return this.xhr=null,t.ActiveXObject?this.xhr=new ActiveXObject("Microsoft.XMLHTTP"):t.XMLHttpRequest&&(this.xhr=new XMLHttpRequest),this.xhr&&(this.xhr.onreadystatechange=function(){if(4==s.xhr.readyState&&200==s.xhr.status){var t=s.xhr.responseText;e.json===!0&&"undefined"!=typeof JSON&&(t=JSON.parse(t)),s.doneCallback&&s.doneCallback.apply(s.host,[t,s.xhr])}else 4==s.xhr.readyState&&s.failCallback&&s.failCallback.apply(s.host,[s.xhr]);s.alwaysCallback&&s.alwaysCallback.apply(s.host,[s.xhr])}),"get"==e.method?this.xhr.open("GET",e.url+i(e.data,e.url),!0):(this.xhr.open(e.method,e.url,!0),this.setHeaders({"X-Requested-With":"XMLHttpRequest","Content-type":"application/x-www-form-urlencoded"})),e.headers&&"object"==typeof e.headers&&this.setHeaders(e.headers),setTimeout(function(){"get"==e.method?s.xhr.send():s.xhr.send(i(e.data))},20),this},done:function(t){return this.doneCallback=t,this},fail:function(t){return this.failCallback=t,this},always:function(t){return this.alwaysCallback=t,this},setHeaders:function(t){for(var e in t)this.xhr&&this.xhr.setRequestHeader(e,t[e])}};return s.process(e)}}}(window,void 0);
